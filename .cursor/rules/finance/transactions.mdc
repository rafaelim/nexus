---
alwaysApply: true
---

# Transactions - Business Rules

## Overview
Transactions represent individual income and expense entries. They can be created manually or linked to expenses for recurring payment tracking.

## Related Files

### Backend
- **API Endpoint**: `backend/app/api/v1/transactions.py`
- **Service**: `backend/app/domain/finance/services/transaction_service.py`
- **Repository**: `backend/app/domain/finance/repositories/transaction_repository.py`
- **DTO**: `backend/app/domain/finance/dto/transaction_dto.py`
- **Validations**: `backend/app/domain/finance/validations/transaction_validations.py`
- **Database Schema**: `backend/db/schema.sql` (finance_transactions table)
- **Database Model**: `backend/app/core/database.py` (finance_transactions table definition)

### Frontend
- **Service**: `frontend/src/services/finance/transactionService.ts`
- **Pages**:
  - `frontend/src/pages/finance/Transactions.tsx`
  - `frontend/src/pages/finance/Dashboard.tsx` (displays transactions)
- **Components**:
  - `frontend/src/pages/finance/components/TransactionForm.tsx`

## Data Model

### Required Fields
- `date`: Date (required)
- `amount`: Decimal (required, must be > 0)
- `category_id`: UUID (required, must exist and belong to user)

### Optional Fields
- `description`: String (nullable)
- `expense_id`: UUID (nullable) - Links transaction to an expense
- `tags`: Array of strings (nullable)
- `payment_method`: String (nullable)
- `notes`: String (nullable)

### Computed Fields
- `created_at`: Timestamp
- `updated_at`: Timestamp
- `deleted_at`: Timestamp (nullable) - Set when transaction is soft deleted

## Validation Functions

All validation logic is centralized in `backend/app/domain/finance/validations/transaction_validations.py`. The service layer uses these functions to validate transaction data before creating or updating records.

### Core Validation Functions

1. **`validate_amount(amount: float)`**
   - Validates that amount is greater than 0
   - Raises `400` error if amount is <= 0

2. **`validate_category_exists(user_id: UUID, category_id: UUID)`**
   - Async function that validates category exists and belongs to user
   - Raises `404` error if category not found

3. **`validate_expense_exists(user_id: UUID, expense_id: UUID)`**
   - Async function that validates expense exists and belongs to user
   - Raises `404` error if expense not found
   - Used when `expense_id` is provided in transaction creation

### Composite Validation Functions

4. **`validate_transaction_create(user_id: UUID, category_id: UUID, amount: float, expense_id: Optional[UUID] = None)`**
   - Orchestrates all validations for transaction creation
   - Calls: `validate_amount`, `validate_category_exists`, `validate_expense_exists` (if expense_id provided)
   - Used in `TransactionService.create_transaction()`

### Usage Pattern

```python
# In TransactionService.create_transaction()
await validate_transaction_create(
    user_id,
    transaction_data.category_id,
    transaction_data.amount,
    transaction_data.expense_id
)
```

## Validation Rules

### Create Validation

1. **Amount**
   - Must be greater than 0
   - Required field

2. **Category**
   - Must exist in the database
   - Must belong to the current user
   - Required field

3. **Expense ID**
   - Optional field
   - If provided, must exist and belong to user
   - Used to link transaction to an expense and track payment progress

4. **Date**
   - Must be a valid date
   - No future date restrictions (can be in the past or future)

5. **Description, Tags, Payment Method, Notes**
   - All optional fields
   - No specific validation rules

## Business Logic

### Create Transaction

**Rules:**
1. Validate category exists and belongs to user
2. Validate `expense_id` if provided
3. Amount must be greater than 0
4. Create transaction record
5. If `expense_id` is provided, update expense (see "Expense Selection" below)

**Expense Selection**

When creating a transaction, user can optionally select an expense via `expense_id` to pre-fill data and track recurring payments:

1. If `expense_id` is provided:
   - Expense must exist and belong to user
   - Expense must be `is_active = true` (can be validated, but not strictly required)
   - Transaction is linked via `expense_id`
   - Transaction fields can be pre-filled from expense (amount, description, category, notes) but user can override all values
2. After transaction creation with `expense_id`:
   - **For Installment Expenses:**
     - Increment `payments_completed` by 1
     - If `payments_completed >= total_payments`:
       - Automatically set `is_active = false`
       - Expense is now completed
   - **For Ongoing Expenses:**
     - No automatic state changes
     - `payments_completed` remains 0 (not tracked)

**Note**: Expenses are used to:
- Pre-fill transaction data (optional)
- Track recurring payment progress (for installments)
- Link transactions to their source expense for reporting

**Errors:**
- `404`: Category not found
- `404`: Expense not found (if `expense_id` provided)

**Note**: Transactions cannot be updated. To modify a transaction, delete it and create a new one.

### Delete Transaction

**Rules:**
1. Verify transaction exists and belongs to user
2. Exclude already deleted transactions (`deleted_at IS NULL`)
3. Soft delete (set `deleted_at` timestamp, do not permanently remove from database)
4. Deleted transactions are excluded from normal queries but remain in database for historical reports
5. Note: Deleting a transaction does not reverse expense updates (e.g., `payments_completed`)

**Errors:**
- `404`: Transaction not found (or transaction is already deleted)

### Get Transactions

**Rules:**
1. Filter by current user
2. Exclude deleted transactions by default (`deleted_at IS NULL`)
3. Optional filters:
   - `start_date`: Filter transactions on or after this date
   - `end_date`: Filter transactions on or before this date
   - `category_id`: Filter by category
   - `limit`: Maximum number of results
   - `offset`: Number of results to skip (for pagination)
4. Results are ordered by date (descending)
5. For reports, deleted transactions can be included by passing `include_deleted=true` (if implemented)

### Get Transaction by ID

**Rules:**
1. Verify transaction exists
2. Verify transaction belongs to user
3. Exclude deleted transactions by default (`deleted_at IS NULL`)
4. Return transaction details

**Errors:**
- `404`: Transaction not found (or transaction is deleted)

## API Endpoints

### POST `/api/v1/transactions`
Create a new transaction

### GET `/api/v1/transactions`
Get all transactions (optional query parameters: `start_date`, `end_date`, `category_id`, `limit`, `offset`)

### GET `/api/v1/transactions/{transaction_id}`
Get a specific transaction

### DELETE `/api/v1/transactions/{transaction_id}`
Soft delete a transaction

## Future Considerations

- Transaction templates
- Bulk transaction import
- Transaction attachments/receipts
- Recurring transaction automation
- Transaction splitting (multiple categories per transaction)
